name: Release
run-name: >
  Release ${{ github.event_name == 'workflow_dispatch' && inputs.version || github.ref_name }}

on:
    push:
      tags: 
        - ^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-z0-9]+)?$
    workflow_dispatch:
      inputs:
         version:
          description: 'Desired version of the package (without prefixing with "v")'
          required: true
          type: string

jobs:
    build-pack:
        runs-on: ubuntu-latest
        defaults:
            run: 
                working-directory: ./src
        steps:
            - uses: actions/checkout@v4

            - name: Set version variable
              id: set_version
              run: |
                if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                  echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
                else
                  echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV
                fi

            - name: Setup dotnet 9.x.x
              uses: actions/setup-dotnet@v4
              with: 
                dotnet-version: 9.x.x

            - name: restore
              run: dotnet restore

            - name: build
              run: dotnet build -c Release  --no-restore 

            - name: test
              run: dotnet test -c Release --no-build

            - name: pack
              run: dotnet pack -c Release ./JsonMigration/JsonMigration.csproj --no-build --output ../output -p:Version=${{ env.VERSION }} -p:SymbolPackageFormat=snupkg

            - name: publish artifact
              uses: actions/upload-artifact@v4
              with:
                name: package
                path: ./output
                retention-days: 7

    publish-internal:
        runs-on: ubuntu-latest
        needs: build-pack

        steps:
          - name: download artifact
            uses: actions/download-artifact@v4
            with:
              name: package
              path: ./output
        
          - name: Setup dotnet 9.x.x
            uses: actions/setup-dotnet@v4
            with: 
              dotnet-version: 9.x.x 
              source-url: https://nuget.pkg.github.com/garcipat/index.json
            env:
              NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

          - name: Push generated package to GitHub registry
            run: dotnet nuget push ./output/*.nupkg --source https://nuget.pkg.github.com/garcipat/index.json --api-key ${{ env.GITHUB_TOKEN }} --skip-duplicate
              dotnet nuget push ./output/*.snupkg --source https://nuget.pkg.github.com/garcipat/index.json --api-key ${{ env.GITHUB_TOKEN }} --skip-duplicate
            env:
              GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
          